name: Build skill ZIP

on:
  push:
    branches: [main]
    paths:
      - 'core/**'
      - 'references/**'
      - 'scripts/**'
      - 'SKILL.md'
      - 'requirements.txt'
      - 'version.json'

permissions:
  contents: write

jobs:
  build-zip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build brief-compliance.zip
        run: |
          tmp=$(mktemp -d)
          dest="$tmp/brief-compliance"
          mkdir -p "$dest"

          # Copy the files that belong in the ZIP
          cp -r core "$dest/core"
          cp -r references "$dest/references"
          cp -r scripts "$dest/scripts"
          cp SKILL.md "$dest/SKILL.md"
          cp requirements.txt "$dest/requirements.txt"
          cp version.json "$dest/version.json"

          # Remove any __pycache__ or .pyc files
          find "$dest" -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find "$dest" -name '*.pyc' -delete 2>/dev/null || true

          # Build the ZIP
          (cd "$tmp" && zip -r "$GITHUB_WORKSPACE/brief-compliance.zip" brief-compliance/)

      - name: Check for changes
        id: diff
        run: |
          git diff --quiet brief-compliance.zip && echo "changed=false" >> "$GITHUB_OUTPUT" || echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit updated ZIP
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add brief-compliance.zip
          git commit -m "Rebuild brief-compliance.zip [automated]"
          git push
